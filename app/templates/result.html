<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分析结果 - 教学流程图智能批阅系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .score-card {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .score-value {
            font-size: 3rem;
            font-weight: bold;
        }
        .score-label {
            font-size: 1.2rem;
            color: #666;
        }
        .score-high {
            background-color: #d4edda;
            color: #155724;
        }
        .score-medium {
            background-color: #fff3cd;
            color: #856404;
        }
        .score-low {
            background-color: #f8d7da;
            color: #721c24;
        }
        .feedback-section {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .suggestion-item {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
        }
        .image-container {
            text-align: center;
            margin: 20px 0;
        }
        .image-container img {
            max-width: 100%;
            max-height: 800px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.3s;
        }
        .image-container img:hover {
            transform: scale(1.02);
        }
        .fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            overflow: auto;
            text-align: center;
            padding: 20px;
        }
        .fullscreen-image {
            max-width: 95%;
            max-height: 95%;
            margin: auto;
            display: block;
            cursor: zoom-out;
        }
        .close-button {
            position: absolute;
            top: 15px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }
        .zoom-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1010;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 8px 15px;
            border-radius: 20px;
        }
        .zoom-button {
            background: #007bff;
            border: none;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            margin: 0 5px;
            cursor: pointer;
        }
        .detail-item {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #ccc;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .detail-item.valid {
            border-left-color: #198754;  /* Bootstrap success color */
        }
        .detail-item.invalid {
            border-left-color: #dc3545;  /* Bootstrap danger color */
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">教学流程图智能批阅系统</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>分析结果</h3>
                    </div>
                    <div class="card-body">
                        <div class="image-container">
                            <img src="{{ url_for('static', filename=image_path) }}" alt="流程图" class="img-fluid">
                        </div>
                        
                        {% if vis_image_path %}
                        <div class="image-container mt-4">
                            <h4>识别结果可视化</h4>
                            <img src="{{ url_for('static', filename=vis_image_path) }}" alt="识别结果可视化" class="img-fluid">
                        </div>
                        {% endif %}
                        
                        <!-- 识别详情 -->
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>识别详情</h5>
                                        <ul class="nav nav-tabs card-header-tabs" id="recognitionTabs" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="shapes-tab" data-bs-toggle="tab" data-bs-target="#shapes" type="button" role="tab" aria-controls="shapes" aria-selected="true">图形 ({{ shapes|length }})</button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="texts-tab" data-bs-toggle="tab" data-bs-target="#texts" type="button" role="tab" aria-controls="texts" aria-selected="false">文本 ({{ text_regions|length }})</button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="nodes-tab" data-bs-toggle="tab" data-bs-target="#nodes" type="button" role="tab" aria-controls="nodes" aria-selected="false">节点 ({{ nodes|length }})</button>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="card-body">
                                        <div class="tab-content" id="recognitionTabsContent">
                                            <!-- 图形信息 -->
                                            <div class="tab-pane fade show active" id="shapes" role="tabpanel" aria-labelledby="shapes-tab">
                                                <div class="table-responsive">
                                                    <table class="table table-striped table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>#</th>
                                                                <th>类型</th>
                                                                <th>位置 (x, y)</th>
                                                                <th>尺寸 (w, h)</th>
                                                                <th>面积</th>
                                                                <th>关联文本</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for shape in shapes %}
                                                            <tr>
                                                                <td>{{ loop.index }}</td>
                                                                <td>{{ shape.type }}</td>
                                                                <td>({{ shape.position.x }}, {{ shape.position.y }})</td>
                                                                <td>({{ shape.bbox[2] }}, {{ shape.bbox[3] }})</td>
                                                                <td>{{ shape.area|int }}</td>
                                                                <td>{{ shape.text }}</td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            
                                            <!-- 文本信息 -->
                                            <div class="tab-pane fade" id="texts" role="tabpanel" aria-labelledby="texts-tab">
                                                <div class="table-responsive">
                                                    <table class="table table-striped table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>#</th>
                                                                <th>文本内容</th>
                                                                <th>位置 (x, y)</th>
                                                                <th>尺寸 (w, h)</th>
                                                                {% if text_regions and text_regions[0].confidence is defined %}
                                                                <th>置信度</th>
                                                                {% endif %}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for text in text_regions %}
                                                            <tr>
                                                                <td>{{ loop.index }}</td>
                                                                <td>{{ text.text }}</td>
                                                                <td>({{ text.position.x }}, {{ text.position.y }})</td>
                                                                <td>({{ text.bbox[2] }}, {{ text.bbox[3] }})</td>
                                                                {% if text.confidence is defined %}
                                                                <td>{{ "%.2f"|format(text.confidence) }}</td>
                                                                {% endif %}
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            
                                            <!-- 节点信息 -->
                                            <div class="tab-pane fade" id="nodes" role="tabpanel" aria-labelledby="nodes-tab">
                                                <div class="table-responsive">
                                                    <table class="table table-striped table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>ID</th>
                                                                <th>类型</th>
                                                                <th>文本</th>
                                                                <th>位置 (x, y)</th>
                                                                <th>连接到</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for node in nodes %}
                                                            <tr>
                                                                <td>{{ node.id }}</td>
                                                                <td>{{ node.type }}</td>
                                                                <td>{{ node.text }}</td>
                                                                <td>({{ node.position.x }}, {{ node.position.y }})</td>
                                                                <td>
                                                                    {% if node.connections %}
                                                                        {{ node.connections|join(', ') }}
                                                                    {% else %}
                                                                        无
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <!-- 总分 -->
                            <div class="col-md-4 offset-md-4">
                                <div class="score-card 
                                    {% if result.scores.总分 >= 80 %}score-high
                                    {% elif result.scores.总分 >= 60 %}score-medium
                                    {% else %}score-low{% endif %}">
                                    <div class="score-value">{{ result.scores.总分 if result.scores.总分 is defined else 0 }}</div>
                                    <div class="score-label">总分</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <!-- 各项评分 -->
                            <div class="col-md-3">
                                <div class="score-card 
                                    {% if result.scores.逻辑性 >= 8 %}score-high
                                    {% elif result.scores.逻辑性 >= 6 %}score-medium
                                    {% else %}score-low{% endif %}">
                                    <div class="score-value">{{ result.scores.逻辑性 if result.scores.逻辑性 is defined else 0 }}</div>
                                    <div class="score-label">逻辑性</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="score-card 
                                    {% if result.scores.合理性 >= 8 %}score-high
                                    {% elif result.scores.合理性 >= 6 %}score-medium
                                    {% else %}score-low{% endif %}">
                                    <div class="score-value">{{ result.scores.合理性 if result.scores.合理性 is defined else 0 }}</div>
                                    <div class="score-label">合理性</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="score-card 
                                    {% if result.scores.清晰度 >= 8 %}score-high
                                    {% elif result.scores.清晰度 >= 6 %}score-medium
                                    {% else %}score-low{% endif %}">
                                    <div class="score-value">{{ result.scores.清晰度 if result.scores.清晰度 is defined else 0 }}</div>
                                    <div class="score-label">清晰度</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="score-card 
                                    {% if result.scores.创新性 >= 8 %}score-high
                                    {% elif result.scores.创新性 >= 6 %}score-medium
                                    {% else %}score-low{% endif %}">
                                    <div class="score-value">{{ result.scores.创新性 if result.scores.创新性 is defined else 0 }}</div>
                                    <div class="score-label">创新性</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 统计信息 -->
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>流程图统计</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><strong>总节点数：</strong> {{ result.statistics.total_nodes if result.statistics.total_nodes is defined else 0 }}</p>
                                                <p><strong>符合规范：</strong> 
                                                    {% if result.符合规范 is defined and result.符合规范 %}
                                                        <span class="badge bg-success">是</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">否</span>
                                                    {% endif %}
                                                </p>
                                            </div>
                                            <div class="col-md-6">
                                                <p><strong>节点类型统计：</strong></p>
                                                <ul>
                                                    {% if result.statistics.node_types is defined %}
                                                        {% for type, count in result.statistics.node_types.items() %}
                                                            <li>{{ type }}: {{ count }}</li>
                                                        {% endfor %}
                                                    {% else %}
                                                        <li>无数据</li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 反馈意见 -->
                        <div class="feedback-section mt-4">
                            <h4>评价反馈</h4>
                            <div class="card mb-3">
                                <div class="card-body">
                                    <p>{{ result.feedback if result.feedback is defined else '无反馈意见' }}</p>
                                </div>
                            </div>
                            
                            {% if result.改进建议 is defined and result.改进建议|length > 0 %}
                                <h4>改进建议</h4>
                                <div class="list-group">
                                    {% for suggestion in result.改进建议 %}
                                        <div class="suggestion-item">
                                            <i class="bi bi-lightbulb"></i> {{ suggestion }}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 在原有的结果展示区域后添加验证结果部分 -->
    <div class="container mt-4">
        <!-- 将原本隐藏的验证结果显示出来 -->
        <div class="validation-results">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">规则符合度分析</h5>
                </div>
                <div class="card-body">
                    <div class="score">
                        <p>匹配度评分：<span id="score" class="badge bg-primary">{{ validation.score if validation is defined and validation.score is defined else 'N/A' }}</span></p>
                    </div>
                    <div class="feedback">
                        <p>总体评价：<span id="feedback" class="text-muted">{{ validation.feedback if validation is defined and validation.feedback is defined else '未进行验证或无法验证' }}</span></p>
                    </div>
                    <div class="details">
                        <h6>详细分析：</h6>
                        <div id="validationDetails">
                            {% if validation is defined and validation.details is defined %}
                                {% for detail in validation.details %}
                                    <div class="detail-item {{ 'valid' if detail.is_valid else 'invalid' }}">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><strong>图形类型：</strong>{{ detail.shape_type }}</p>
                                                <p><strong>文本内容：</strong>{{ detail.text }}</p>
                                            </div>
                                            <div class="col-md-6">
                                                <p><strong>判断结果：</strong>
                                                    <span class="badge {{ 'bg-success' if detail.is_valid else 'bg-danger' }}">
                                                        {{ '符合规则' if detail.is_valid else '不符合规则' }}
                                                    </span>
                                                </p>
                                                <p><strong>判断理由：</strong>{{ detail.reason }}</p>
                                                {% if detail.suggestion %}
                                                    <p><strong>修改建议：</strong>{{ detail.suggestion }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted">无验证数据</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加新的"返回首页"按钮在页脚之前，居中显示 -->
    <div class="container mt-5 mb-5">
        <div class="text-center">
            <a href="/" class="btn btn-primary btn-lg px-5">返回首页</a>
        </div>
    </div>

    <footer class="bg-light py-4 mt-5">
        <div class="container text-center">
            <p>© 2025 教学流程图智能批阅系统 | 基于计算机视觉和人工智能技术</p>
        </div>
    </footer>

    <!-- 全屏图片显示覆盖层 -->
    <div id="fullscreen-overlay" class="fullscreen-overlay">
        <span class="close-button" onclick="closeFullscreen()">&times;</span>
        <img id="fullscreen-image" class="fullscreen-image" src="" alt="放大图片">
        <div class="zoom-controls">
            <button class="zoom-button" onclick="zoomImage(-0.1)">-</button>
            <button class="zoom-button" onclick="zoomImage(0.1)">+</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 当前缩放级别
        let currentZoom = 1;
        
        // 为所有图片添加点击事件
        document.addEventListener('DOMContentLoaded', function() {
            const images = document.querySelectorAll('.image-container img');
            images.forEach(img => {
                img.addEventListener('click', function() {
                    showFullscreen(this.src);
                });
            });
        });
        
        // 显示全屏图片
        function showFullscreen(src) {
            const fullscreenImage = document.getElementById('fullscreen-image');
            fullscreenImage.src = src;
            document.getElementById('fullscreen-overlay').style.display = 'block';
            currentZoom = 1;
            fullscreenImage.style.transform = `scale(${currentZoom})`;
            
            // 阻止滚动
            document.body.style.overflow = 'hidden';
        }
        
        // 关闭全屏图片
        function closeFullscreen() {
            document.getElementById('fullscreen-overlay').style.display = 'none';
            
            // 恢复滚动
            document.body.style.overflow = '';
        }
        
        // 缩放图片
        function zoomImage(delta) {
            currentZoom += delta;
            // 限制缩放范围在0.5到3之间
            currentZoom = Math.max(0.5, Math.min(3, currentZoom));
            document.getElementById('fullscreen-image').style.transform = `scale(${currentZoom})`;
        }
        
        // 点击全屏图片外的区域关闭全屏
        document.getElementById('fullscreen-overlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeFullscreen();
            }
        });
        
        // 键盘事件处理
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('fullscreen-overlay').style.display === 'block') {
                if (e.key === 'Escape') {
                    closeFullscreen();
                } else if (e.key === '+' || e.key === '=') {
                    zoomImage(0.1);
                } else if (e.key === '-') {
                    zoomImage(-0.1);
                }
            }
        });
    </script>
</body>
</html> 